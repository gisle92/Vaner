# Vaner API & Component Reference

This document covers every public API that ships with the Vaner project: the
scheduled Firebase Cloud Function, the Flutter application entry points, UI
components/screens, shared data structures, and support services. Each section
summarises responsibilities, describes dependencies, and provides usage
examples.

---

## 1. Platform & Data Model

### 1.1 Firebase Projects & Initialization
- `DefaultFirebaseOptions.currentPlatform` (`lib/firebase_options.dart`) exposes
  the platform-aware `FirebaseOptions` bundle generated by the FlutterFire CLI.
- Always call `Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform)`
  before touching any Firebase SDK. See `main()` for a canonical example.

```dart
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  runApp(const VanerApp());
}
```

### 1.2 Firestore Collections
| Path | Description | Key Fields |
|------|-------------|------------|
| `users/{uid}` | User profile & notification mirror | `email`, `displayName`, `photoURL`, `lastLoginAt`, `notification.enabled`, `notification.minuteOfDay` |
| `users/{uid}/habits/{habitId}` | Active habits shown in the app | `name`, `categoryId`, `targetDays`, `createdAt`, `isArchived` |
| `users/{uid}/habitLogs/{habitId_date}` | Daily habit status logs | `habitId`, `date` (`yyyy-MM-dd`), `status` (`done`/`skipped`), `updatedAt` |
| `users/{uid}/devices/{token}` | Push-enabled devices | `token`, `platform`, `enabled`, timestamps |
| `users/{uid}/settings/notification` | Editable notification preferences | `enabled`, `minuteOfDay`, `updatedAt` |

Helper: `_dateKeyFromDate(DateTime date)` (file-private) normalises any `DateTime`
into the canonical `yyyy-MM-dd` string that powers log IDs and comparisons.

---

## 2. Cloud Functions (Node 18 runtime)

### 2.1 `sendDailyHabitReminders`
- **Location:** `functions/src/index.ts`
- **Signature:** `export const sendDailyHabitReminders = onSchedule(config, handler)`
- **Schedule:** Runs every 5 minutes in the `Europe/Oslo` timezone.
- **Responsibility:**
  1. Finds users whose `notification.enabled` is true and whose
     `notification.minuteOfDay` falls within ±5 minutes of the current minute.
  2. Fetches all enabled device tokens under `users/{uid}/devices`.
  3. Sends a multicast FCM notification containing a simple reminder payload.
- **Notification payload:**
  ```json
  {
    "notification": { "title": "Vaner", "body": "Husk dagens vaner ✨" },
    "data": { "userId": "<uid>" }
  }
  ```
- **Error handling:** Logs every step via `firebase-functions/logger` and keeps
  iterating even if one user send fails.
- **Usage instructions:**
  - Deploy with `firebase deploy --only functions:sendDailyHabitReminders`.
  - Ensure Firestore documents contain `notification.enabled` and
    `notification.minuteOfDay`. The mobile app writes these via the
    `NotificationSettingsScreen`.
  - Device tokens are created by `PushNotifications.init` (see §4.5). Without
    device entries under `users/{uid}/devices`, pushes are skipped.
  - For local testing, run `firebase emulators:start --only functions,firestore`
    and manually invoke the scheduled function via the Cloud Functions emulator
    UI or `gcloud beta emulators scheduler` cron triggers.

---

## 3. Flutter Application Surface
All public widgets (classes without a leading underscore) live in `lib/main.dart`
unless noted. They compose the logged-out experience, authenticated habit views,
settings, and supplementary flows.

### 3.1 Entry Point & Theme
| API | Description | Example |
|-----|-------------|---------|
| `main()` | Boots Flutter, initialises Firebase, launches `VanerApp`. | See §1.1 snippet. |
| `class VanerApp extends StatelessWidget` | Configures Material 3 theme, card/fab styling, and sets the `home` to `AuthGate`. Use it as the top-level `runApp` widget. | `runApp(const VanerApp());` |

### 3.2 Authentication Flow
| Component | Purpose | Key APIs | Usage Notes |
|-----------|---------|----------|-------------|
| `AuthGate` | Listens to `FirebaseAuth.instance.authStateChanges()` and decides whether to show `SignInScreen` or `HomeScreen`. | Constructor: `const AuthGate()` (no args). | Embed as the `home` widget or route guard. Handles loading spinner until auth state resolves. |
| `SignInScreen` | Presents a minimal Google sign-in UI. | Method: `Future<void> _signInWithGoogle(BuildContext)`. | Uses `GoogleAuthProvider`; calls `signInWithPopup` on web and `signInWithProvider` elsewhere. Catching `FirebaseAuthException` to show snackbars. |

**Example:** route configuration to reuse `AuthGate` in a larger app shell.
```dart
return MaterialApp(
  routes: {
    '/': (_) => const AuthGate(),
    '/about': (_) => const AboutScreen(),
  },
);
```

### 3.3 Informational Screen
| Component | Purpose & Usage |
|-----------|-----------------|
| `AboutScreen` | Stateless screen with descriptive copy and two external links (`_siteUrl`, `_privacyUrl`). Use `Navigator.push(context, MaterialPageRoute(builder: (_) => const AboutScreen()))` to display it (as done in `HomeScreen`). |

### 3.4 Home & Habit Management
`HomeScreen` is the primary authenticated UI.

- **Constructor:** `HomeScreen({required User user})`
- **Data accessors:**
  - `_habitsRef` → `users/{uid}/habits`
  - `_logsRef` → `users/{uid}/habitLogs`
- **Lifecycle:** On `initState`, ensures the profile document exists and invokes
  `PushNotifications().init(user)` to register device tokens.
- **Key interactions:**
  | Method | Responsibility | Firestore impact |
  |--------|----------------|------------------|
  | `_addHabitDialog` | Opens `_NewHabitDialog`, then writes the selected `name`, `categoryId`, `targetDays` to the habits collection. | Adds a new habit document. |
  | `_setStatus(habitId, status)` | Persists a `done` or `skipped` entry for today under `habitLogs`. | Upserts `habitLogs/{habitId_today}` with timestamps. |
  | `_archiveHabit` | Sets `isArchived` to true on the habit. | Updates habit document only. |
  | `_deleteHabit` | Confirms with the user, deletes all logs for the habit, then removes the habit itself via a batched write. | Deletes multiple documents atomically. |
  | `_signOut` | Calls `FirebaseAuth.instance.signOut()`. | n/a |

- **Child widgets exposed publicly:**
  - `HabitDetailScreen` (navigated to via `MaterialPageRoute`).
  - `NotificationSettingsScreen` (see below).

**Usage example:** embedding `HomeScreen` elsewhere.
```dart
StreamBuilder<User?>(
  stream: FirebaseAuth.instance.authStateChanges(),
  builder: (context, snapshot) {
    final user = snapshot.data;
    if (user == null) return const SignInScreen();
    return HomeScreen(user: user);
  },
);
```

### 3.5 Habit Detail View
| Component | Description | Usage |
|-----------|-------------|-------|
| `HabitDetailScreen` | Stateless analytics page for a single habit. Computes 30-day completion, streaks, and optional goal progress (via `_GoalCard`). | Instantiate with `HabitDetailScreen(userId: uid, habitId: id, habitName: name, targetDays: targetDays)` and push onto the navigator. |

### 3.6 Notification Settings UI
| Component | Description | Key Methods |
|-----------|-------------|-------------|
| `NotificationSettingsScreen` | Stateful page to enable/disable reminders and pick a time. Mirrors settings to both `users/{uid}/settings/notification` and the root `users/{uid}` doc (under `notification`). | `_load()` (initial fetch), `_save()` (writes Firestore + shows snackbar), `_pickTime()` (opens system time picker). |

**Usage:**
```dart
IconButton(
  icon: const Icon(Icons.notifications),
  onPressed: () {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (_) => NotificationSettingsScreen(userId: user.uid),
      ),
    );
  },
);
```

### 3.7 Push Notification Service
| API | Description | Usage |
|-----|-------------|-------|
| `class PushNotifications` | Singleton service wrapping `FirebaseMessaging`. Handles permission prompts, token persistence, token refresh, and foreground logging. | Call `PushNotifications().init(currentUser)` once after login (already done inside `HomeScreen.initState`). |
| `Future<void> init(User user)` | Entry point. Skips web, requests permission, saves the current token under `users/{uid}/devices/{token}`, subscribes to refreshes. | Invoke whenever a user signs in (safe to call repeatedly). |

To manually trigger token registration in another flow:
```dart
await PushNotifications().init(FirebaseAuth.instance.currentUser!);
```

### 3.8 Habit Metadata Helpers
| API | Description | Usage |
|-----|-------------|-------|
| `class HabitCategory` | Immutable value object with `id`, `label`, `emoji`. | Instantiate for new categories or iterate over `habitCategories`. |
| `const List<HabitCategory> habitCategories` | Default category list (health, workout, mind, social, other). | Used across dialogs & list chips. Extend by appending new `HabitCategory` entries. |
| `const Map<String, List<String>> habitSuggestions` | Category → example habits. | Feed into `_NewHabitDialog` or any UI that needs ready-made ideas. |

### 3.9 Generated Firebase Options
Although auto-generated, `DefaultFirebaseOptions` is part of the public surface if
you embed these widgets in another host application. Use it exactly as shown in
§1.1; never modify the constants manually—rerun the FlutterFire CLI instead.

---

## 4. Putting It Together

1. **Bootstrap:** Call `main()` to initialise Firebase and load `VanerApp`.
2. **Authentication:** `AuthGate` decides between `SignInScreen` and
   `HomeScreen` using the real-time auth stream.
3. **Habit lifecycle:** Within `HomeScreen`, users can create habits through the
   `_NewHabitDialog`, which relies on `habitCategories` & `habitSuggestions`.
   Status updates are persisted via `_setStatus`, and detailed analytics are
   surfaced through `HabitDetailScreen`.
4. **Notifications:** `NotificationSettingsScreen` writes the desired reminder
   window. `PushNotifications` stores device tokens so the backend function
   `sendDailyHabitReminders` can deliver pushes at the configured minute.
5. **Static assets:** Landing pages under `/landing` and `/docs` provide the web
   marketing presence (no programmatic APIs exposed).

---

## 5. Extending the APIs
- **Adding habit metadata:** Extend `habitCategories` and `habitSuggestions` with
  new entries, then redeploy the Flutter app. All widgets iterate over these
  constants, so new chips appear automatically.
- **Custom reminder windows:** Adjust the `window` constant in
  `sendDailyHabitReminders` to widen/narrow the tolerated difference between the
  current time and `notification.minuteOfDay`.
- **Additional push payload fields:** Modify the `message.data` object in the
  Cloud Function; mobile clients can use `FirebaseMessaging.onMessage` to react
  to custom `data` keys.
- **Embedding screens elsewhere:** All public widgets (`VanerApp`, `AuthGate`,
  `SignInScreen`, `AboutScreen`, `HomeScreen`, `HabitDetailScreen`,
  `NotificationSettingsScreen`) are regular Flutter widgets and can be reused in
  custom navigation stacks as long as a logged-in `User` is provided where
  required.

This reference intentionally avoids private, underscored classes inside
`main.dart`; they remain implementation details. Use the documented APIs to
integrate Vaner into other shells, to add new functionality, or to maintain the
Firebase back end.
